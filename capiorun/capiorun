#!/usr/bin/env python3

import os, subprocess, argparse, time, sys
import signal

from loguru import logger

logger.remove()
logger.add(
    sink=lambda msg: print(msg, end=''),  # or use sys.stdout
    format="<green>{time:DD/MM/YYYY HH:mm:ss}</green> | <cyan>capiorun</cyan> | <level>{level: <8}</level> | <level>{message}</level>",
    colorize=True
)

parser = argparse.ArgumentParser(prog='capiorun', description='Simplify the execution of workflows running with CAPIO',
                                 epilog='Developed by Marco Edoardo Santimaria')

parser.add_argument("-d", "--capio-dir", required=True, help="CAPIO virtual mount point")
parser.add_argument("-w", "--workflow-name", default="CAPIO", help="Name of the workflow")
parser.add_argument("-n", "--app-name", required=True, help="CAPIO Application step name")
parser.add_argument("-L", "--log-level", default="-1", help="CAPIO log level when running in debug mode")
parser.add_argument("-l", "--libcapio", default="libcapio_posix.so", help="Absolute path to libcapio_poix.so")
parser.add_argument("-s", "--server", default="capio_server", help="Absolute path to capio_server")
parser.add_argument("-c", "--capiocl", default="--no-config", help="Absolute path to the CAPIO-CL configuration file")
parser.add_argument('args', nargs=argparse.REMAINDER, help="Command to launch with capio")

server_process = None
step_process = None

if __name__ == "__main__":
    args = parser.parse_args()

    if not os.path.exists(f"/dev/shm/{args.workflow_name}"):
        logger.info(f"Starting capio server with config file: {args.capiocl}")
        logger.info(f"CAPIO_LOG_LEVEL     = {args.log_level}")
        logger.info(f"CAPIO_WORKFLOW_NAME = {args.workflow_name}")
        logger.info(f"CAPIO_APP_NAME      = {args.app_name}")
        logger.info(f"CAPIO_DIR           = {args.capio_dir}")
        logger.info(f"CAPIO-CL CONFIG     = {args.capiocl}")
        if not os.path.exists(args.capiocl):
            logger.critical(f"File {args.capiocl} does not exists. aborting execution...")
            exit(1)
        server_env = os.environ.copy()
        server_env["CAPIO_DIR"] = args.capio_dir
        server_env["CAPIO_LOG_LEVEL"] = args.log_level
        server_process = subprocess.Popen(
            [args.server, ("--config " + args.capiocl) if args.capiocl != "--no-config" else args.capiocl],
            env=server_env,
            stdout=sys.stdout, stderr=sys.stderr)

        logger.debug(f"capio_server PID: {server_process.pid}")
        time.sleep(1)

    else:
        logger.debug(f"An instance of capio_server with workflow name {args.workflow_name} already exists!")

    step_env = os.environ.copy()
    step_env["CAPIO_WORKFLOW_NAME"] = args.workflow_name
    step_env["CAPIO_APP_NAME"] = args.app_name
    step_env["CAPIO_DIR"] = args.capio_dir
    step_env["CAPIO_LOG_LEVEL"] = args.log_level
    step_env["LD_PRELOAD"] = args.libcapio

    logger.info(f"Starting workflow steps with following environment variables:")
    logger.info(f"CAPIO_LOG_LEVEL     = {args.log_level}")
    logger.info(f"CAPIO_WORKFLOW_NAME = {args.workflow_name}")
    logger.info(f"CAPIO_APP_NAME      = {args.app_name}")
    logger.info(f"CAPIO_DIR           = {args.capio_dir}")
    logger.info(f"LD_PRELOAD          = {args.libcapio}")
    logger.info(f"command             = {" ".join(args.args)}")
    try:
        step_process = subprocess.Popen(
            args.args,
            env=step_env,
            stdout=sys.stdout, stderr=sys.stderr
        )

        step_process.wait()
    except Exception as e:
        logger.critical("An error occurred in startup of workflow app: {}".format(e))

    if server_process is not None:
        logger.info(f"Terminating instance of capio_server")
        server_process.send_signal(signal.SIGTERM)
        time.sleep(2)
        logger.success("Terminated CAPIO server instance")
